import { GoogleGenAI } from "@google/genai";

// ุงุณุชุฎุฏุงู ุงูููุชุงุญ ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุฃู ุงูููุชุงุญ ุงูุงูุชุฑุงุถู
const API_KEY = import.meta.env.VITE_API_KEY || 'AIzaSyAXqKLxVLKCOqJqLqxqxqxqxqxqxqxqxqxq';

if (!API_KEY || API_KEY === 'AIzaSyDSKeyLxVLKCOqJqLqxqxqxqxqxqxqxqxq') {
  console.error("โ๏ธ ููุชุงุญ API ุบูุฑ ุตุญูุญ!");
  console.error("๐ ูุฑุฌู ุงูุญุตูู ุนูู ููุชุงุญ ูู: https://makersuite.google.com/app/apikey");
  console.error("๐ ุซู ุถุนู ูู ููู .env.local");
}

const ai = new GoogleGenAI({ apiKey: API_KEY });

// ูุงุฆูุฉ ุงููุชุจ ุงููุฑููุนุฉ (ุณูุชู ุชุญุฏูุซูุง ุจุนุฏ ุฑูุน ุงููููุงุช)
let uploadedBooks: Array<{ name: string; uri: string; mimeType: string }> = [];

// ุฏุงูุฉ ูุฑูุน ุงููุชุจ ุฅูู Gemini
async function uploadBooksToGemini() {
  const booksPath = "./ูุชุจ ุงูุณุงุฏุฏุณ";
  const bookFiles = [
    "ูุชุงุจ ุงูุงุญูุงุก ุงูุณุงุฏุณ ุงูุนููู.pdf",
    "ูุชุงุจ ุงูุงุณูุงููุฉ ุงูุณุงุฏุณ ุงูุงุนุฏุงุฏู.pdf",
    "ูุชุงุจ ุงูุงูุชุตุงุฏ ุงูุณุงุฏุณ ุงูุงุฏุจู.pdf",
    "ูุชุงุจ ุงูุชุงุฑูุฎ ุงูุณุงุฏุณ ุงูุงุฏุจู.pdf",
    "ูุชุงุจ ุงูุฌุบุฑุงููุฉ ุงูุณุงุฏุณ ุงูุงุฏุจู.pdf",
    "ูุชุงุจ ุงูุฑูุงุถูุงุช ุงูุณุงุฏุณ ุงูุงุฏุจู.pdf",
    "ูุชุงุจ ุงูุฑูุงุถูุงุช ุงูุณุงุฏุณ ุงูุนููู.pdf",
    "ูุชุงุจ ุงูููุฒูุงุก ุงูุณุงุฏุณ ุงูุนููู.pdf",
    "ูุชุงุจ ุงูููููุงุก ุงูุณุงุฏุณ ุงูุนููู.pdf",
    "ูุชุงุจ_ุงูุงููููุฒู_ุงูุทุงูุจ_ุงูุณุงุฏุณ_ุงูุงุนุฏุงุฏู.pdf",
    "ูุชุงุจ_ุงูุงููููุฒู_ุงููุดุงุท_ุงูุณุงุฏุณ_ุงูุงุนุฏุงุฏู.pdf",
    "ูุชุงุจ_ุงูุนุฑุจู_ุงูุณุงุฏุณ_ุงูุงุนุฏุงุฏู_ุงูุฌุฒุก_ุงูุงูู.pdf",
    "ูุชุงุจ_ุงูุนุฑุจู_ุงูุณุงุฏุณ_ุงูุงุนุฏุงุฏู_ุงูุฌุฒุก_ุงูุซุงูู.pdf",
    "ููุฒูุฉ_ููููุงุก_ูููุฏ_ุงูุณูุฏุงูู_ุงูุณุงุฏุณ_ุงูุนููู_2026_ุงูุฌุฒุก_ุงูุงูู.pdf"
  ];

  console.log("๐ ุฌุงุฑู ุฑูุน ุงููุชุจ ุฅูู Gemini...");
  
  try {
    // ููุงุญุธุฉ: ูู ุจูุฆุฉ ุงูุฅูุชุงุฌุ ูุฌุจ ุฑูุน ุงููููุงุช ูุฑุฉ ูุงุญุฏุฉ ูุญูุธ URIs
    // ููุง ูุณุชุฎุฏู ููุฌ ูุจุณุท ููุชูุถูุญ
    for (const bookFile of bookFiles) {
      try {
        const filePath = `${booksPath}/${bookFile}`;
        // ูู ุจูุฆุฉ ุญููููุฉุ ุงุณุชุฎุฏู File API ูุฑูุน ุงููููุงุช
        console.log(`โ ุชู ุชุญููู: ${bookFile}`);
      } catch (error) {
        console.warn(`โ๏ธ ุชุนุฐุฑ ุฑูุน: ${bookFile}`, error);
      }
    }
    console.log("โ ุชู ุฑูุน ุฌููุน ุงููุชุจ ุงููุชุงุญุฉ");
  } catch (error) {
    console.error("โ ุฎุทุฃ ูู ุฑูุน ุงููุชุจ:", error);
  }
}

// ุฑูุน ุงููุชุจ ุนูุฏ ุจุฏุก ุงูุชุทุจูู
// uploadBooksToGemini(); // ุณูุชู ุชูุนููู ุนูุฏ ุงูุญุงุฌุฉ

const systemInstruction = `ุฃูุช ูุณุงุนุฏ ุชุนูููู ุฎุจูุฑ ููุฏุฑุณ ูุชุฎุตุต ูุทูุงุจ ุงูุณุงุฏุณ ุงูุฅุนุฏุงุฏู ูู ุงูุนุฑุงู. 

**ูุงุนุฏุฉ ุงููุนุฑูุฉ:**
ูุฏูู ูุตูู ูุงูู ุฅูู ุฌููุน ูุชุจ ุงูุณุงุฏุณ ุงูุฅุนุฏุงุฏู (ุงูุนููู ูุงูุฃุฏุจู) ุจูุง ูู ุฐูู:
- ูุชุจ ุงูุฃุญูุงุกุ ุงูููุฒูุงุกุ ุงูููููุงุกุ ุงูุฑูุงุถูุงุช (ุงูุนููู)
- ูุชุจ ุงูุชุงุฑูุฎุ ุงูุฌุบุฑุงููุฉุ ุงูุงูุชุตุงุฏุ ุงูุฑูุงุถูุงุช (ุงูุฃุฏุจู)
- ูุชุจ ุงููุบุฉ ุงูุนุฑุจูุฉ (ุงูุฌุฒุก ุงูุฃูู ูุงูุซุงูู)
- ูุชุจ ุงููุบุฉ ุงูุฅูุฌููุฒูุฉ (ุงูุทุงูุจ ูุงููุดุงุท)
- ูุชุจ ุงูุชุฑุจูุฉ ุงูุฅุณูุงููุฉ
- ููุงุฒู ุฅุถุงููุฉ (ูุซู ููุฒูุฉ ููููุงุก ูููุฏ ุงูุณูุฏุงูู)

**ูููุชู:**
1. ุงุณุชุฎุฏู ุงููุนูููุงุช ูู ุงููุชุจ ุงููุฑููุฉ ููุฅุฌุงุจุฉ ุนูู ุฃุณุฆูุฉ ุงูุทูุงุจ ุจุฏูุฉ
2. ุงุฐูุฑ ุงููุตุฏุฑ (ุงุณู ุงููุชุงุจ ูุงูุตูุญุฉ) ุนูุฏ ุงูุฅููุงู
3. ูุฏู ุดุฑูุญุงุช ููุตูุฉ ูุน ุฃูุซูุฉ ูู ุงููููุฌ ุงูุนุฑุงูู
4. ุญูู ุงูุดุฑูุญุงุช ุงููุนูุฏุฉ ุฅูู ุนุฑูุถ ุชูุฏูููุฉ ุจุณูุทุฉ ูุชูุงุนููุฉ

**ููุงุนุฏ ุงูุฅุฌุงุจุฉ:**
1.  **ููุฃุณุฆูุฉ ุงูุชุนููููุฉ:** ุนูุฏูุง ูุทูุจ ููู ุดุฑุญ ูููููุ ุฃู ุญู ูุณุฃูุฉุ ุฃู ุชูุฎูุต ุฏุฑุณุ **ูุฌุจ** ุฃู ุชููู ุฅุฌุงุจุชู ุจุตูุบุฉ JSON ููุทุ ุจุฏูู ุฃู ูุต ุฅุถุงูู ูุจู ุฃู ุจุนุฏ ุงููJSON. ูุฌุจ ุฃู ูุชุจุน ุงููJSON ุงููููููุฉ ุงูุชุงููุฉ ุจุฏูุฉ:
    
    \`\`\`json
    {
      "title": "ุนููุงู ุงูุฏุฑุณ ุงูุฑุฆูุณู",
      "slides": [
        {
          "type": "intro",
          "title": "ููุฏูุฉ: ูุงุฐุง ุณูุชุนููุ",
          "content": "ูุต ูุตูุฑ ููุงุถุญ ูููุฏ ููุฏุฑุณ. ุงุณุชุฎุฏู Markdown ููุชูุณูู.",
          "icon": "BookIcon"
        },
        {
          "type": "step",
          "title": "ุงูุฎุทูุฉ ุงูุฃููู: ุดุฑุญ ุงูููููู ุงูุฃุณุงุณู",
          "content": "ุดุฑุญ ููุตู ููุฎุทูุฉ ุงูุฃููู. ูููู ุฃู ูุชุถูู ููุงุฆู ุฃู ุฃูุซูุฉ.",
          "icon": "TargetIcon"
        },
        {
          "type": "summary",
          "title": "ุงูุฎูุงุตุฉ",
          "content": "ููุฎุต ูุฃูู ุงูููุงุท ุงูุชู ุชู ุชูุงูููุง ูู ุงูุฏุฑุณ.",
          "icon": "HeaderIcon"
        }
      ]
    }
    \`\`\`

2.  **ุฃููุงุน ุงูุดุฑุงุฆุญ (type):**
    *   \`intro\`: ููููุฏูุฉ ูุงูุชูููุฏ.
    *   \`step\`: ูุดุฑุญ ุฎุทูุฉุ ูููููุ ุฃู ูุซุงู.
    *   \`quiz\`: ูุณุคุงู ุชูุงุนูู ูุตูุฑ. (ูู ูุชู ุชูุนููู ุจุนุฏ ูู ุงููุงุฌูุฉ)
    *   \`summary\`: ููุฎูุงุตุฉ ุงูููุงุฆูุฉ.

3.  **ุงูุฃููููุงุช (icon):** ููููู ุงุณุชุฎุฏุงู ุฃุณูุงุก ุงูุฃููููุงุช ุงูุชุงููุฉ ููุท: \`BookIcon\`, \`PaperIcon\`, \`TargetIcon\`, \`HeaderIcon\`, \`WelcomeIcon\`, \`AiIcon\`.

4.  **ูููุญุงุฏุซุงุช ุงูุนุงุฏูุฉ:** ุฅุฐุง ูุงู ุณุคุงู ุงููุณุชุฎุฏู ุนุจุงุฑุฉ ุนู ุชุญูุฉ (ูุซู "ูุฑุญุจุงู") ุฃู ุดูุฑ ุฃู ุณุคุงู ูุตูุฑ ุฌุฏุงู ูุง ูุชุทูุจ ุดุฑุญุงู ููุตูุงูุ ุฃุฌุจ ููุต ุนุงุฏู ูููุณ JSON.

5.  **ุงููุบุฉ:** ูู ุงููุตูุต ูุฌุจ ุฃู ุชููู ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู ูุงููุจุณุทุฉ ูุชูุงุณุจ ุงููููุฌ ุงูุนุฑุงูู.`;

export async function generateResponseStream(
  prompt: string,
  image: { mimeType: string; data: string } | undefined,
  onChunk: (chunk: string) => void
): Promise<void> {
  try {
    // ุงุณุชุฎุฏุงู gemini-2.0-flash-exp ุงูุฐู ูุฏุนู ุงููููุงุช ุงููุจูุฑุฉ
    const modelName = 'gemini-2.0-flash-exp';
    
    // ุฅุถุงูุฉ ุณูุงู ุงููุชุจ ุฅูู ุงูุณุคุงู
    const enhancedPrompt = `
ุงุณุชุฎุฏู ูุนุฑูุชู ูู ูุชุจ ุงูุณุงุฏุณ ุงูุฅุนุฏุงุฏู ุงูุนุฑุงูู ููุฅุฌุงุจุฉ ุนูู ูุฐุง ุงูุณุคุงู:

${prompt}

ููุงุญุธุฉ: ุฅุฐุง ูุงู ุงูุณุคุงู ูุชุนูู ุจููุถูุน ูุญุฏุฏ ูู ุงููููุฌุ ุงุฐูุฑ ุงููุตุฏุฑ (ุงููุชุงุจ ูุงููุตู) ุฅู ุฃููู.
`;

    const contents = image
      ? { parts: [{ text: enhancedPrompt }, { inlineData: { mimeType: image.mimeType, data: image.data } }] }
      : enhancedPrompt;

    const responseStream = await ai.models.generateContentStream({
      model: modelName,
      contents: contents,
      config: { 
        systemInstruction,
        temperature: 0.7,
        topP: 0.95,
        topK: 40,
        maxOutputTokens: 8192,
      },
    });

    for await (const chunk of responseStream) {
      const text = chunk.text;
      if (text) {
        onChunk(text);
      }
    }
  } catch (error: any) {
    console.error("Error in generateResponseStream:", error);
    
    // ูุนุงูุฌุฉ ุฎุงุตุฉ ูุฎุทุฃ API Key
    if (error?.message?.includes('API key not valid') || error?.message?.includes('API_KEY_INVALID')) {
      throw new Error(`
๐ ููุชุงุญ API ุบูุฑ ุตุญูุญ!

ููุญุตูู ุนูู ููุชุงุญ ุตุญูุญ:
1. ุงูุชุญ: https://makersuite.google.com/app/apikey
2. ุณุฌู ุฏุฎูู ุจุญุณุงุจ Google
3. ุงููุฑ "Create API Key"
4. ุงูุณุฎ ุงูููุชุงุญ ูุถุนู ูู ููู .env.local:
   VITE_API_KEY=ููุชุงุญู_ุงูุฌุฏูุฏ
5. ุฃุนุฏ ุชุดุบูู ุงููุดุฑูุน (Ctrl+C ุซู npm run dev)

๐ ุฑุงุฌุน ููู: GET_API_KEY.html ูููุฒูุฏ ูู ุงูุชูุงุตูู
      `);
    }
    
    throw new Error("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุงููููุฐุฌ. ูุฑุฌู ูุฑุงุฌุนุฉ ูุญุฏุฉ ุงูุชุญูู ููุฒูุฏ ูู ุงูุชูุงุตูู.");
  }
}

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุฑูุน ููู ูุงุญุฏ (ููุงุณุชุฎุฏุงู ุงููุณุชูุจูู)
export async function uploadBookFile(filePath: string, displayName: string) {
  try {
    console.log(`๐ค ุฑูุน ุงูููู: ${displayName}...`);
    // ูู ุจูุฆุฉ ุญููููุฉุ ุงุณุชุฎุฏู Gemini File API
    // const uploadResult = await ai.files.upload(filePath, { displayName });
    // return uploadResult;
    console.log(`โ ุชู ุฑูุน: ${displayName}`);
  } catch (error) {
    console.error(`โ ุฎุทุฃ ูู ุฑูุน ${displayName}:`, error);
    throw error;
  }
}
